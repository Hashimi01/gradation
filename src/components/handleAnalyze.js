"use client"
import { updateRatingAtIndex } from "../firebase/firebase-operations";

// โ ุฏุงูุฉ ุฅุฑุณุงู ุงูุฑุณุงุฆู ุฅูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู


// โ ุฏุงูุฉ ุชุญููู ุงูุชุตููุชุงุช
const handleAnalyze = async (votes, setError, setRatings, setAnalyzing, loadInitialData) => {
  if (votes.length === 0) {
    setError("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุญููููุง.");
    return;
  }

  setAnalyzing(true);
  setError("");

  // ๐ ุฅุนุฏุงุฏ ุงูุฑุณุงูุฉ ุงูุชู ุณูุชู ุฅุฑุณุงููุง ุฅูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
  const message = `
ูุง ูู ุงููุนูู ุงูุฃูุซุฑ ุดููููุง ุจูู ูุฐู ุงูุฃุณูุงุก ุงูููุชุฑุญุฉ ููุฏูุนุฉุ
ุงููุนูู ุงูุดุงูู ูู ุงูุฐู ูุบุทู ุฃูุจุฑ ุนุฏุฏ ูู ุงูุฃุณูุงุก ุงูููุชุฑุญุฉุ ุจุญูุซ ููุซู ูุณุจุฉ ุชุฒูุฏ ุนู 37% ูู ุงูุฃุณูุงุก.

ุฅุฐุง ูุงูุช ุงููุงุฆูุฉ ุชุญุชูู ุนูู ูุนูู ูุงุญุฏ ุฃู ุงุซููู ููุทุ ููุฑุฌู ุฅููุงู ุงููุชูุฌุฉ ููุตุจุญ ุงููุฌููุน ุซูุงุซุฉ ูุนุงูู ุจุงุณุชุฎุฏุงู ูุนุงูู ููุทููุฉ ูููุงุณุจุฉ.
ูุฌุจ ุฃู ูููู ุนุฏุฏ ุงูุฃุณูุงุก ูู ุงููุนุงูู ุงููุถุงูุฉ ุฃูู ูู ุงูุนุฏุฏ ุงูุฃุณุงุณู ูุชุฌูุจ ุงูุชูุฑุงุฑ ุบูุฑ ุงูููุทูู.

๐ **ุงูุชุนูููุงุช ุงูุตุงุฑูุฉ ููุฅุฌุงุจุฉ:**
- ูุฌุจ ุฃู ุชุชููู ุงูุฅุฌุงุจุฉ ูู 3 ุนูุงุตุฑ ุจุงูุถุจุทุ ุญุชู ุฅุฐุง ูู ููู ููุงู ุจูุงูุงุช ูุงููุฉ.
- ุฃุฌุจ ููุท ุจุตูุบุฉ JSON ุจุฏูู ุฃู ูุต ุฅุถุงูู.
- ุชุฃูุฏ ูู ุฃู ุงููุชูุฌุฉ ุชุชุถูู **3 ูุนุงูู ุจุงูุถุจุท**.
- ูู ูุนูู ูุฌุจ ุฃู ูููู **ุฌููุฉ ูู 2 ุฅูู 4 ูููุงุช ูุญุฏ ุฃูุตู**.
- ุนุฏุฏ ุงูุฃุณูุงุก ููู ูุนูู ูุฌุจ ุฃู ูููู ููุทูููุง ููููุง ููุจูุงูุงุช.

๐น **ูุซุงู ุนูู ุงููุชูุฌุฉ ุงููุทููุจุฉ:**
\`\`\`json
[
  {"ุงููุนูู": "ุฏูุนุฉ ุงูุฃูู", "ุงูุนุฏุฏ": 15},
  {"ุงููุนูู": "ุนุงุดู ุงูุชุฌุงุฑุจ", "ุงูุนุฏุฏ": 12},
  {"ุงููุนูู": "ูุญุจู ุงูุงุจุชูุงุฑ", "ุงูุนุฏุฏ": 9}
]
\`\`\`

### ูุฐู ูู ูุงุฆูุฉ ุงูุฃุณูุงุก ุงูููุชุฑุญุฉ:
${JSON.stringify(votes, null, 2)}
`;



  try {
    // ๐น ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุฅูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    const response = await sendMessage(message);
    if (!response || !response.content) {
      throw new Error("โ ุงูุงุณุชุฌุงุจุฉ ูู ุงูุฎุงุฏู ุบูุฑ ุตุงูุญุฉ.");
    }

    console.log("๐ ุงูุฑุฏ ุงูุฎุงู:", response.content);

    // โ ุชูุธูู ูุฅุฒุงูุฉ ุฃู ุฃููุงุฏ ุบูุฑ ูุงุฒูุฉ
    const cleanedContent = response.content.replace(/```json|```/g, "").trim();
    const parsedContent = JSON.parse(cleanedContent);
    console.log("โ ุงููุญุชูู ุงููุญูู:", parsedContent);

    if (Array.isArray(parsedContent)) {
      for (let i = 0; i < parsedContent.length; i++) {
        const { ุงููุนูู, ุงูุนุฏุฏ } = parsedContent[i];
        const success = await updateRatingAtIndex(i, ุงููุนูู, ุงูุนุฏุฏ);
        console.log(`๐ ุชุญุฏูุซ ุงูููุฑุณ ${i} ุจู: ${ุงููุนูู}, ุงูุนุฏุฏ: ${ุงูุนุฏุฏ}, ุงููุฌุงุญ: ${success}`);

        if (!success) {
          setError(`โ๏ธ ูุดู ุชุญุฏูุซ ุงูุนูุตุฑ ูู ุงูููุฑุณ ${i}`);
          break;
        }
      }

      setRatings(parsedContent);
    } else {
      setError("โ๏ธ ุงูุฑุฏ ุบูุฑ ุตุงูุญ.");
    }
  } catch (err) {
    setError("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช.");
    console.error(err);
  } finally {
    setAnalyzing(false);
  }
};
export const sendMessage = async (message) => {
    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: [{ role: 'user', content: message }] }),
      });
  
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
  
      const data = await response.json();
      return data.message;
    } catch (error) {
      console.error('โ Chat Error:', error);
      throw error; // ุฑูู ุงูุฎุทุฃ ููุชู ุงูุชุนุงูู ูุนู ูู ุงููุณุชุฏุนู
    }
  };
export default handleAnalyze;
